---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

library(magrittr)
```

# visR <img src='man/figures/logo.png' align="right" height="131.5" />

The goal of visR is to enable fit-for-purpose, reusable clinical and medical research focused visualizations and tables with sensible defaults and based on sound [graphical principles](https://graphicsprinciples.github.io/).

[Package documentation](https://openpharma.github.io/visR/)

## Motivation

By using a common package for visualising data analysis results in the clinical development process, we want to have a **positive influence** on 

* **choice of visualisation** by making it easy explore different visualisation and to use impactful visualisations fit-for-purpose
* effective visual communication by making it easy to **implement best practices** 

We are not judging on what visualisation you chose for your research question, but want facilitate and support good practice.

You can read more about the philosophy and architecture in the [repo wiki](https://github.com/openpharma/visR/wiki).

## Lifecycle and status

The package is still experimental and under active development with a current focus on developing a stable API. 

<!-- badges: start -->

| Badge | Description
|----------------------|-------------------|
| [![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)     | Development stage |
| [![Codecov test coverage](https://codecov.io/gh/openpharma/visR/branch/develop/graph/badge.svg)](https://codecov.io/gh/openpharma/visR?branch=develop) | Unit testing coverage - currently points at `develop` |
| [![R-CMD-check](https://github.com/openpharma/visR/actions/workflows/check-standard.yaml/badge.svg?branch=develop)](https://github.com/openpharma/visR/actions/workflows/check-standard.yaml) | `develop` branch |
| [![R-CMD-check](https://github.com/openpharma/visR/actions/workflows/check-standard.yaml/badge.svg?branch=master)](https://github.com/openpharma/visR/actions/workflows/check-standard.yaml) | `master` branch |
| [![pkgdown](https://github.com/openpharma/visR/actions/workflows/makedocs.yml/badge.svg)](https://github.com/openpharma/visR/actions/workflows/makedocs.yml) | Documentation building to [Github pages](https://openpharma.github.io/visR/) |
<!-- badges: end -->


## Installation

Install the development version from [GitHub](https://github.com/) with:

``` r
devtools::install_github("openpharma/visR")
```

## Example

This is a basic example to demonstrate how the API can be used to add layers to a visualisation. In this example a time to event analysis. The example calculates stratified Kaplan-Meier by treatment and then plots. Additional functions can be used to add uncertainty intervals, censoring information and a risk table. 

```{r example, warning=FALSE, message = FALSE}
library(visR)
library(survival)
library(dplyr)
library(tidyr) 
library(ggplot2)

# Need to add working example!

# adtte %>%
#   vr_KM_est(strata = "TRTP", conf.int = 0.90) %>%
#   vr_plot(legend_position = "right", x_unit = "Days") %>%
#   add_CI(style = "ribbon",
#          linetype = 3) %>%
#   add_CNSR(shape = 3, size = 1) %>%
#   add_risktable(
#     min_at_risk = 3,
#     statlist = c("n.risk", "n.event", "n.censor"),
#     label = c("At risk", "Event", "Censor"),
#     collapse = F
#   )
```


## Contribution 

Please note that the 'visR' project is released with a [Contributor Code of Conduct](CODE_OF_CONDUCT.md). By contributing to this project, you agree to abide by its terms.

### Code contributors

```{r, echo=FALSE, warning=FALSE, message = FALSE}
library(dplyr)
library(glue)
library(ggplot2)
library(GithubMetrics) #remotes::install_github("openpharma/GithubMetrics")
library(gitsum) #remotes::install_github("lorenzwalthert/gitsum)

local_repo <- parse_log_detailed()

commits <- gh_commits_get(
  full_names = "openpharma/visR",
  days_back = 365*10,
  .token = Sys.getenv("GH_API_TOKEN_README")
  ) %>%
  mutate(date = as.Date(datetime)) %>%
  filter(!author %in% c(".gitconfig missing email","actions-user"))

left_join(
  commits %>%
    group_by(author) %>%
    summarise(commits_all = n()),
  commits %>%
    filter(date > Sys.Date() - 28*6) %>%
    group_by(author) %>%
    summarise(commits_6months = n())
  ) %>%
  arrange(-commits_6months) %>%
  left_join(
    gh_user_get(unique(commits$author),
    .token = Sys.getenv("GH_API_TOKEN_README")
    ),
    by = c("author"="username")
  ) %>%
  mutate(
    blog = case_when(
      blog == "" ~ "",
      TRUE ~ as.character(glue('<a href="{blog}">link</a>'))
      ),
    author = case_when(
      !is.na(name) ~ paste0(name,"(",author,")"),
      TRUE ~ author
    ),
    author = glue('<img src="{avatar}" alt="" height="30"> {author}')
    ) %>%
  select(author,commits_all,commits_6months,company,location,blog) %>%
  knitr::kable()
```


### Code activity

```{r, echo=FALSE, warning=FALSE, message = FALSE}

# plot
commits %>%
  group_by(
    Month = lubridate::floor_date(date, "month"),
    author
    ) %>%
  summarise(
    Commits = n()
  ) %>%
  ggplot() +
  geom_col(
    aes(x = Month, y = Commits, fill = author)
  ) +
  theme_minimal() +
  labs(
    title = "Commit activity in openpharma/visR",
    subtitle = "Colour = author (names hidden)"
  ) + theme(legend.position = "none")
```

## Function activity

```{r, echo=FALSE, warning=FALSE, message = FALSE}
lines <- local_repo %>%
  unnest_log() %>%
  set_changed_file_to_latest_name() %>%
  add_line_history()

r_files <- grep("^R/", lines$changed_file, value = TRUE)

to_plot <- lines %>%
  filter(changed_file %in% r_files) %>%
  add_n_times_changed_file() %>%
  filter(n_times_changed_file >= 10)
ggplot(to_plot, aes(x = date, y = current_lines)) + 
  geom_step() + 
  scale_y_continuous(name = "Number of Lines", limits = c(0, NA)) + 
  facet_wrap(~changed_file, scales = "free_y", ncol = 4) +
  ggthemes::theme_hc()
```

## Code coverage 

Last time readme built.

```{r}
covr::package_coverage()
```
