---
title: "Survival Analysis with visR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Survival Analysis with visR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This short tutorial illustrates a typical use case in clinical development - the analysis of time to a certain event (e.g., death) in different populations. Typically, data obtained in randomized clinical trials (RCT) can be used to estimate the overall survival of patients in one group (e.g., treated with drug X) vs another group (e.g., treated with drug Y) and thus determine if there is a difference between these treatments.

For a more thorough introduction to Survival Analysis, we recommend the following tutorial: https://bioconnector.github.io/workshops/r-survival.html

In this example, we will work with patient data from NCCTG Lung Cancer dataset that is part of the `survival` package. Another vignette presents an example using a data set following the CDISC ADaM standard. 

```{r imports, echo=FALSE, warning=FALSE, message=FALSE}
#library(dplyr)
#library(ggplot2)
#library(survival)
library(visR)
```

## Global Document Setup
```{r globalSetup}
# Constants
DATASET <- paste0("NCCTG Lung Cancer Dataset (from survival package ", 
                  packageVersion("survival"), ")")

# Globql formatting options
options(digits = 3)

# Global ggplot settings
# theme_set(theme_classic())

# Global table settings 
options(DT.options = list(pageLength = 10, 
                          language = list(search = 'Filter:'), 
                          scrollX = TRUE))

lung_cohort <- survival::lung
#data(lung_cohort)


```


## Creating and rendering tables

Visualizing tables, like the tableone or risktables, is a two-step process in visR . First, a data.frame (or tibble) is created by a `get_XXX()` function (e.g. `get_tableone()`). Secondly, the data.frame can be displayed by calling the function `render()`. The advantage of this process is that data summaries can be created, used and adjusted throughout an analysis, while at every step data summaries can be displayed or even be downloaded.

### Cohort Overview (Tableone)
Populations are usually displayed as a so-called tableone. Function `get_tableone` creates a tibble that includes populations summaries. 

```{r table1_get_default}
tab1 <- get_tableone(lung_cohort)

```

Function `render` nicely displays the tableone. Additionally, visR includes a wrapper function to create and display a `tableone` in only one function call.

```{r table1_render_default}

render(tab1, title = "Overview over Lung Cancer patients", datasource = DATASET)
tableone(lung_cohort, title = "Overview over Lung Cancer patients", datasource = DATASET)

```

Creating and visualizing a tableone with default settings is very simple and can be done with one line of code. However, there are further customization options.

In both the getter and the wrapper functions, a stratifier can be defined and the column displaying total information can be removed.

```{r table1_get_options}

tab1 <- get_tableone(lung_cohort, strata = "sex", overall = F)

tableone(lung_cohort, title = "Overview over Lung Cancer patients", datasource = DATASET, strata = "sex", overall = F)

```

visR's `render` supports three different rendering engines to be as flexible as possible. By default, `render` uses `gt`. Additional engines are `datatable` (`dt`) to include easy downloading options...

```{r table1_render_options_dt}

tableone(lung_cohort, strata = "sex", 
         title = "Overview over Lung Cancer patients", datasource = DATASET, 
         engine = "dt")


```

...and `kable` for flexible displaying in various output formats (`html` by default, `latex` supported). 
 
```{r table1_render_options_kable}

tableone(lung_cohort, strata = "sex", 
         title = "Overview over Lung Cancer patients", datasource = DATASET, 
         engine = "kable", output_format="html")

```

Called with `html` as an output format, a html view is displayed; called with `latex` a string containing latex code is printed.

### Time-to-event analysis

## Survival estimation
visR provides a wrapper function to estimate a Kaplan-Meier curve and several functions to visualize the results. This wrapper function is compatible with `%>%` and purrr::map functions without losing traceability of the dataset name.

```{r km_est}
# For the survival estimate, the censor must be 0 or 1
lung_cohort$status <- lung_cohort$status - 1

library(survival)
lung_suvival_object <- lung_cohort %>% estimate_KM(strata = "sex", CNSR = "status", AVAL = "time")
lung_suvival_object
```

## Survival visualization
There are two frequently used ways to estimate time-to-event data: As a risk table and as a Kaplan-Meier curve. In principle, visR allows to either visualize a risk table and a Kaplan-Meier curve separately, or both together in one plot.

### Displaying the risktable
Creating and visualizing a risk table separately works in the exact same way as for the tableone (above): First, `get_risktable()` creates a tibble with risk information that can still be changed. Secondly, the risk table can be rendered to be displayed.

```{r km_tab}
rt <- get_risktable(lung_suvival_object)
render(rt, title = "Overview over survival rates of Lung Cancer patients", datasource = DATASET)
```

The risktable is only one piece of information that can be extracted from a survival object with a `get_XXX` to then be rendered.

```{r km_tab_options}

render(lung_suvival_object  %>% get_summary(), title = "Summary", datasource = DATASET)
render(lung_suvival_object  %>% get_pvalue(), title = "P-values", datasource = DATASET)
render(lung_suvival_object  %>% get_quantile(), title = "Quantile Information", datasource = DATASET)
render(lung_suvival_object  %>% get_COX_HR(), title = "COX estimate", datasource = DATASET)

```

### Plotting the Kaplan-Meier
Alternatively, the survival data can be plotted as a Kaplan-Meier curve. In visR, a plot is in most cases a ggplot object and adapting the plot follows the general principle of creating a plot and then adding visual contents step-by-step. 

```{r km_plot}
gg <- plot(lung_suvival_object)
gg 
gg %>% add_CI() 
gg %>% add_CI() %>% add_CNSR(shape = 3, size = 2)
```

visR incudes a wrapper function to create a risktable and then add it directly to a Kaplan-Meier plot.

```{r km_add}
gg %>% add_CI() %>% add_CNSR(shape = 3, size = 2) %>% add_risktable()
```


